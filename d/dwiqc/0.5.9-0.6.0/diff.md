# Comparing `tmp/dwiqc-0.5.9-py2.py3-none-any.whl.zip` & `tmp/dwiqc-0.6.0-py2.py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,24 +1,24 @@
-Zip file size: 24746 bytes, number of entries: 22
--rw-r--r--  2.0 unx      225 b- defN 23-Jun-29 17:19 dwiqc/__init__.py
--rw-r--r--  2.0 unx      247 b- defN 23-Jul-05 11:26 dwiqc/__version__.py
--rw-r--r--  2.0 unx     1352 b- defN 23-Jun-29 17:19 dwiqc/browser/__init__.py
--rw-r--r--  2.0 unx       61 b- defN 23-Jun-29 17:19 dwiqc/cli/__init__.py
--rw-r--r--  2.0 unx     6941 b- defN 23-Jun-29 17:19 dwiqc/cli/get.py
--rw-r--r--  2.0 unx     5945 b- defN 23-Jun-29 18:37 dwiqc/cli/process.py
--rw-r--r--  2.0 unx     4180 b- defN 23-Jun-29 17:19 dwiqc/cli/tandem.py
--rw-r--r--  2.0 unx      160 b- defN 23-Jun-29 17:19 dwiqc/config/__init__.py
--rw-r--r--  2.0 unx      274 b- defN 23-Jun-29 17:19 dwiqc/config/dwiqc.yaml
--rw-r--r--  2.0 unx       98 b- defN 23-Jun-29 17:19 dwiqc/state/__init__.py
--rw-r--r--  2.0 unx     1892 b- defN 23-Jun-29 17:19 dwiqc/tasks/__init__.py
--rw-r--r--  2.0 unx    10119 b- defN 23-Jul-05 11:24 dwiqc/tasks/prequal.py
--rw-r--r--  2.0 unx     4656 b- defN 23-Jun-29 17:19 dwiqc/tasks/prequal_EQ.py
--rw-r--r--  2.0 unx     6146 b- defN 23-Jul-05 11:24 dwiqc/tasks/qsiprep.py
--rw-r--r--  2.0 unx     3872 b- defN 23-Jun-29 17:19 dwiqc/tasks/qsiprep_EQ.py
--rw-r--r--  2.0 unx    13087 b- defN 23-Jun-29 17:19 dwiqc/xnat/__init__.py
--rwxr-xr-x  2.0 unx     5783 b- defN 23-Jul-05 11:26 dwiqc-0.5.9.data/scripts/dwiQC.py
--rw-r--r--  2.0 unx     1541 b- defN 23-Jul-05 11:26 dwiqc-0.5.9.dist-info/LICENSE
--rw-r--r--  2.0 unx      483 b- defN 23-Jul-05 11:26 dwiqc-0.5.9.dist-info/METADATA
--rw-r--r--  2.0 unx      110 b- defN 23-Jul-05 11:26 dwiqc-0.5.9.dist-info/WHEEL
--rw-r--r--  2.0 unx        6 b- defN 23-Jul-05 11:26 dwiqc-0.5.9.dist-info/top_level.txt
-?rw-rw-r--  2.0 unx     1718 b- defN 23-Jul-05 11:26 dwiqc-0.5.9.dist-info/RECORD
-22 files, 68896 bytes uncompressed, 21994 bytes compressed:  68.1%
+Zip file size: 25957 bytes, number of entries: 22
+-rw-r--r--  2.0 unx      225 b- defN 23-Jul-05 14:23 dwiqc/__init__.py
+-rw-r--r--  2.0 unx      247 b- defN 23-Jul-13 14:27 dwiqc/__version__.py
+-rw-r--r--  2.0 unx     1352 b- defN 23-Jul-05 14:23 dwiqc/browser/__init__.py
+-rw-r--r--  2.0 unx       61 b- defN 23-Jul-05 14:23 dwiqc/cli/__init__.py
+-rw-r--r--  2.0 unx     6941 b- defN 23-Jul-06 18:14 dwiqc/cli/get.py
+-rw-r--r--  2.0 unx     6009 b- defN 23-Jul-07 14:09 dwiqc/cli/process.py
+-rw-r--r--  2.0 unx     4180 b- defN 23-Jul-06 18:14 dwiqc/cli/tandem.py
+-rw-r--r--  2.0 unx      160 b- defN 23-Jul-06 18:14 dwiqc/config/__init__.py
+-rw-r--r--  2.0 unx      274 b- defN 23-Jul-05 14:23 dwiqc/config/dwiqc.yaml
+-rw-r--r--  2.0 unx       98 b- defN 23-Jul-05 14:23 dwiqc/state/__init__.py
+-rw-r--r--  2.0 unx     1892 b- defN 23-Jul-05 14:23 dwiqc/tasks/__init__.py
+-rw-r--r--  2.0 unx    15219 b- defN 23-Jul-12 15:57 dwiqc/tasks/prequal.py
+-rw-r--r--  2.0 unx     4656 b- defN 23-Jul-05 14:23 dwiqc/tasks/prequal_EQ.py
+-rw-r--r--  2.0 unx     7849 b- defN 23-Jul-13 14:00 dwiqc/tasks/qsiprep.py
+-rw-r--r--  2.0 unx     3872 b- defN 23-Jul-05 14:23 dwiqc/tasks/qsiprep_EQ.py
+-rw-r--r--  2.0 unx    13087 b- defN 23-Jul-05 14:23 dwiqc/xnat/__init__.py
+-rwxr-xr-x  2.0 unx     6046 b- defN 23-Jul-13 14:28 dwiqc-0.6.0.data/scripts/dwiQC.py
+-rw-r--r--  2.0 unx     1541 b- defN 23-Jul-13 14:28 dwiqc-0.6.0.dist-info/LICENSE
+-rw-r--r--  2.0 unx      439 b- defN 23-Jul-13 14:28 dwiqc-0.6.0.dist-info/METADATA
+-rw-r--r--  2.0 unx      110 b- defN 23-Jul-13 14:28 dwiqc-0.6.0.dist-info/WHEEL
+-rw-r--r--  2.0 unx        6 b- defN 23-Jul-13 14:28 dwiqc-0.6.0.dist-info/top_level.txt
+-rw-rw-r--  2.0 unx     1718 b- defN 23-Jul-13 14:28 dwiqc-0.6.0.dist-info/RECORD
+22 files, 75982 bytes uncompressed, 23205 bytes compressed:  69.5%
```

## zipnote {}

```diff
@@ -42,26 +42,26 @@
 
 Filename: dwiqc/tasks/qsiprep_EQ.py
 Comment: 
 
 Filename: dwiqc/xnat/__init__.py
 Comment: 
 
-Filename: dwiqc-0.5.9.data/scripts/dwiQC.py
+Filename: dwiqc-0.6.0.data/scripts/dwiQC.py
 Comment: 
 
-Filename: dwiqc-0.5.9.dist-info/LICENSE
+Filename: dwiqc-0.6.0.dist-info/LICENSE
 Comment: 
 
-Filename: dwiqc-0.5.9.dist-info/METADATA
+Filename: dwiqc-0.6.0.dist-info/METADATA
 Comment: 
 
-Filename: dwiqc-0.5.9.dist-info/WHEEL
+Filename: dwiqc-0.6.0.dist-info/WHEEL
 Comment: 
 
-Filename: dwiqc-0.5.9.dist-info/top_level.txt
+Filename: dwiqc-0.6.0.dist-info/top_level.txt
 Comment: 
 
-Filename: dwiqc-0.5.9.dist-info/RECORD
+Filename: dwiqc-0.6.0.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## dwiqc/__version__.py

```diff
@@ -1,6 +1,6 @@
 __title__ = 'dwiqc'
 __description__ = 'Quality Assurance Pipeline for Diffusion MR Data'
 __url__ = 'https://github.com/harvard-nrg/dwiqc'
-__version__ = '0.5.9'
+__version__ = '0.6.0'
 __author__ = 'Neuroinformatics Research Group'
 __author_email__ = 'info@neuroinfo.org'
```

## dwiqc/cli/process.py

```diff
@@ -67,14 +67,15 @@
         prequal_outdir = os.path.join(args.bids_dir, 'derivatives', 'dwiqc-prequal', f'sub-{args.sub}', f'ses-{args.ses}', basename, 'OUTPUTS')
         prequal_task = prequal.Task(
             sub=args.sub,
             ses=args.ses,
             run=args.run,
             bids=args.bids_dir,
             outdir=prequal_outdir,
+            no_gpu=args.no_gpu,
             tempdir=tempfile.gettempdir(),
             pipenv='/sw/apps/prequal'
         )
         os.environ['OPENBLAS_NUM_THREADS'] = '1'
         logger.info(json.dumps(prequal_task.command, indent=1))
         jarray.add(prequal_task.job)
 
@@ -86,14 +87,15 @@
         #os.symlink(qsiprep_outdir, f"{qsiprep_trick}/q")
         qsiprep_task = qsiprep.Task(
             sub=args.sub,
             ses=args.ses,
             run=args.run,
             bids=args.bids_dir,
             outdir=qsiprep_outdir,
+            no_gpu=args.no_gpu,
             tempdir=tempfile.gettempdir(),
             pipenv='/sw/apps/qsiprep'
         )
         os.environ['OPENBLAS_NUM_THREADS'] = '1'
         logger.info(json.dumps(qsiprep_task.command, indent=1))
         #check_for_output(args, qsiprep_outdir)
         jarray.add(qsiprep_task.job)
```

## dwiqc/tasks/prequal.py

```diff
@@ -18,19 +18,20 @@
 
 
 module('load', 'cuda/9.1.85-fasrc01')
 
 # pull in some parameters from the BaseTask class in the __init__.py directory
 
 class Task(tasks.BaseTask):
-	def __init__(self, sub, ses, run, bids, outdir, tempdir=None, pipenv=None):
+	def __init__(self, sub, ses, run, bids, outdir, no_gpu=False, tempdir=None, pipenv=None):
 		self._sub = sub
 		self._ses = ses
 		self._run = run
 		self._bids = bids
+		self._no_gpu = no_gpu
 		self._layout = BIDSLayout(bids)
 		super().__init__(outdir, tempdir, pipenv)
 
 
 	# create an INPUTS dir next to the OUTPUTS dir
 	def copy_inputs(self, inputs_dir):
 		try:
@@ -87,104 +88,147 @@
 		if len(dwi_file) > 1:
 			raise DWISpecError('Found more than one dwi file. Please verify there are no duplicates.')
 		if not dwi_file:
 			raise DWISpecError(f'No dwi scan found for subject {self._sub} session {self._ses} run {self._run}')
 		else:
 			dwi_file = dwi_file.pop()
 
-		series_desc = dwi_file.get_metadata()['SeriesDescription']
+		json_file = self._layout.get(subject=self._sub, session=self._ses, run=self._run, suffix='dwi', extension='.json', return_type='filename').pop()
 
-		if 'ABCD_dMRI_lowSR' in series_desc:
-			# Define the values
-			ABCD_values = """0 27 54
-			2 29 56
-			4 31 58
-			6 33 60
-			8 35 62
-			10 37 64
-			12 39 66
-			14 41 68
-			16 43 70
-			18 45 72
-			20 47 74
-			22 49 76
-			24 51 78
-			26 53 80
-			1 28 55
-			3 30 57
-			5 32 59
-			7 34 61
-			9 36 63
-			11 38 65
-			13 40 67
-			15 42 69
-			17 44 71
-			19 46 73
-			21 48 75
-			23 50 77
-			25 52 79"""
-
-			# Create a text file
-			with open(f"{inputs_dir}/slspec_ABCD_dMRI.txt", "w") as file:
-				# Write the values into the text file
-				file.write(ABCD_values)
-			os.makedirs(self._outdir)
-			shutil.copy(f"{inputs_dir}/slspec_ABCD_dMRI.txt", self._outdir)
-			self._spec = "ABCD"
-
-
-
-
-		# check for the UK Bio bank version of the scan and then create the slspec file accordingly
-
-		elif 'UKbioDiff_ABCDseq_ABCDdvs' in series_desc:
-			# Define Values
-			UKBio_values = """1 25 49
-			3 27 51
-			5 29 53
-			7 31 55
-			9 33 57
-			11 35 59
-			23 47 71
-			13 37 61
-			15 39 63
-			17 41 65
-			19 43 67
-			21 45 69
-			2 26 50
-			4 28 52
-			6 30 54
-			8 32 56
-			10 34 58
-			12 36 60
-			0 24 48
-			14 38 62
-			16 40 64
-			18 42 66
-			20 44 68
-			22 46 70"""
-
-
-			# Create a text file
-			with open(f"{inputs_dir}/slspec_UKBio_dMRI.txt", "w") as file:
-				# Write the values into the text file
-				file.write(UKBio_values)
-
-			os.makedirs(self._outdir)
-			shutil.copy(f"{inputs_dir}/slspec_UKBio_dMRI.txt", self._outdir)
-			self._spec = "UKBio"
-		
+		# Grab the slice timing info
+		slice_timing = dwi_file.get_metadata()['SliceTiming']
 
-		else:
-			logger.info('Unable to determine dwi scan type. Moving on without creating slspec file.')
+		# sort it in ascending order
+		slice_timing.sort()
+
+		# remove any duplicates
+		slice_timing = list(set(slice_timing))
 
+		# get the total number of slices
+		num_slices = len(slice_timing)
+
+		# check if there's an even or odd number of slices, run corresponding helper method
+		if num_slices % 2 == 0:
+			self.even_slices(json_file, inputs_dir)
+
+		else:
+			self.odd_slices(json_file, inputs_dir, num_slices)
 
+		# call method that creates the necessary csv file for prequal
 		self.create_csv(inputs_dir, dwi_file)
+
+		# call method that adds an "IntendedFor" key-value pair to json file (for fieldmaps)
 		self.add_intended_for()
 
+		# call method that checks the manufacturer, scanner model and max bval. that will determine if --nonzero_shells argument needs to be passed to prequal
+		self.check_shells(dwi_file)
+
+	# helper method that creates slspec file for an acquisition with an even number of slices
+
+	# if the number of slices is even, create spec file accordingly. source = https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/eddy/Faq#How_should_my_--slspec_file_look.3F
+    # line 138 edited from `item - 1` to `item - 0`
+
+	def even_slices(self, json_file, inputs_dir):
+		# open the json file and 
+		with open(json_file, 'r') as fp:
+			fcont = fp.read()
+
+		i1 = fcont.find('SliceTiming')
+		i2 = fcont[i1:].find('[')
+		i3 = fcont[i1 + i2:].find(']')
+		cslicetimes = fcont[i1 + i2 + 1:i1 + i2 + i3]
+		slicetimes = list(map(float, cslicetimes.split(',')))
+		sortedslicetimes = sorted(slicetimes)
+		sindx = sorted(range(len(slicetimes)), key=lambda k: slicetimes[k])
+		mb = len(sortedslicetimes) // (sum(1 for a, b in zip(sortedslicetimes, sortedslicetimes[1:]) if a != b) + 1)
+		slspec = [sindx[i:i + mb] for i in range(0, len(sindx), mb)]
+		slspec = [[item - 0 for item in sublist] for sublist in slspec]
+
+		spec_file = f"{inputs_dir}/even_slices_slspec.txt"
+
+		with open(spec_file, 'w') as fp:
+			for sublist in slspec:
+				fp.write(' '.join(str(item) for item in sublist))
+				fp.write('\n')
+
+		os.makedirs(self._outdir)
+		shutil.copy(f"{inputs_dir}/even_slices_slspec.txt", self._outdir)
+		self._spec = "even"
+
+
+	# helper method that generates slspec file for an acquisition with an odd number of slices
+
+	def odd_slices(self, json_file, inputs_dir, num_slices):
+		## build the first column
+
+		col1 = []
+
+		for i in range(0, num_slices, 2):
+			col1.append(i)
+
+		for j in range(1, num_slices, 2):
+			col1.append(j)
+
+		col1 = np.array(col1)
+
+		if len(col1) != num_slices:
+			raise DWISpecError('Spec file column does not match length of slice timing file. Exiting.')
+
+		## build second column
+
+		col2 = []
+
+		for col1_num in col1:
+			col2_num = col1_num + num_slices
+			col2.append(col2_num)
+		col2 = np.array(col2)
+
+		# build third column
+
+		col3 = []
+
+		for col2_num in col2:
+			col3_num = col2_num + num_slices
+			col3.append(col3_num)
+		col3 = np.array(col3)
+
+		all_cols = np.column_stack([col1, col2, col3])
+
+		spec_file = f"{inputs_dir}/odd_slices_slspec.txt"
+
+		np.savetxt(spec_file, data, fmt=['%d', '%d', '%d'])
+
+		os.makedirs(self._outdir)
+		shutil.copy(f"{inputs_dir}/odd_slices_slspec.txt", self._outdir)
+		self._spec = "odd"
+
+	# this method will grab the manufacturer name and model and the max bval value. 
+	# if it is a Siemens Skyra and the max bval is 2000, the non-zero_shells argument needs to be passed to prequal
+	def check_shells(self, dwi_file):
+		# grab the Manufacturer and model from dwi file metadata
+		manufacturer = dwi_file.get_metadata()['Manufacturer']
+		scanner_model = dwi_file.get_metadata()['ManufacturersModelName']
+
+		# load the f val and convert it to a python list. convert the elements from strings to integers
+		bval_file = self._layout.get(subject=self._sub, session=self._ses, run=self._run, suffix='dwi', extension='.bval', return_type='filename').pop()
+
+		bval = open(bval_file, 'r')
+		data = bval.read()
+		data = data.replace('\n', '').split(" ")
+		int_data = [eval(i) for i in data]
+
+		max_val = max(int_data)
+
+		if manufacturer == "Siemens" and scanner_model == "Skyra" and max_val == 2000:
+			self._nonzero_shells = True
+		else:
+			self._nonzero_shells = False
+
+
+
 	# this method will grab the phase encode direction and total readout time for the main dwi scan and both fieldmaps and place them into a csv file named
 	# dtiQA_config.csv
 
 	def create_csv(self, inputs_dir, dwi_file):
 
 
 		# grab TotalReadoutTime from json file
@@ -238,18 +282,14 @@
 		AP_file = self._layout.get(subject=self._sub, session=self._ses, run=self._run, suffix='epi', direction='AP', extension='.nii.gz').pop()
 
 		AP_phase = AP_file.get_metadata()['PhaseEncodingDirection']
 
 		return PA_phase, AP_phase
 
 
-	# ******** this will also need to be added to qsiprep.py ***********
-
-
-
 # this method will add an "IntendedFor" key-value pair to the fieldmap scans
 
 	def add_intended_for(self):
 
 		fmap_json_files = self._layout.get(run=self._run, suffix='epi', extension='.json', return_type='filename')
 
 		dwi_file = os.path.basename(self._layout.get(subject=self._sub, session=self._ses, run=self._run, suffix='dwi', extension='.nii.gz', return_type='filename').pop())
@@ -270,130 +310,234 @@
 	# build the prequal sbatch command and create job
 
 	def build(self):
 		self.add_intended_for()
 		self._tempdir = tempfile.gettempdir()
 		inputs_dir = f'{self._tempdir}/INPUTS/'
 		self.copy_inputs(inputs_dir)
-		if self._spec == "ABCD":
-			self._command = [
-				'selfie',
-				'--lock',
-				'--output-file', self._prov,
-				'singularity',
-				'run',
-				'-e',
-				'--contain',
-				'--nv',
-				'-B',
-				f'{inputs_dir}:/INPUTS/',
-				'-B',
-				f'{self._outdir}:/OUTPUTS',
-				'-B',
-				f'{self._tempdir}:/tmp',
-				'-B',
-				'/n/sw/ncf/apps/freesurfer/6.0.0/license.txt:/APPS/freesurfer/license.txt',
-				'-B',
-				'/n/sw/helmod-rocky8/apps/Core/cuda/9.1.85-fasrc01:/usr/local/cuda',
-				'-B',
-				'/n/nrg_l3/Lab/users/nrgadmin/PreQual/src/CODE/dtiQA_v7/run_dtiQA.py:/CODE/dtiQA_v7/run_dtiQA.py',
-				'-B',
-				'/n/nrg_l3/Lab/users/nrgadmin/PreQual/src/CODE/dtiQA_v7/vis.py:/CODE/dtiQA_v7/vis.py',
-				'/n/sw/ncf/containers/masilab/prequal/1.0.8/prequal.sif',
-				'--save_component_pngs',
-				'j',
-				'--eddy_cuda',
-				'9.1',
-				'--num_threads',
-				'2',
-				'--denoise',
-				'off',
-				'--degibbs',
-				'off',
-				'--rician',
-				'off',
-				'--prenormalize',
-				'on',
-				'--correct_bias',
-				'on',
-				'--topup_first_b0s_only',
-				'--subject',
-				self._sub,
-				'--project',
-				'SSBC',
-				'--session',
-				self._ses
-			]
-
-		elif self._spec == "UKBio":
-
-			self._command = [
-				'selfie',
-				'--lock',
-				'--output-file', self._prov,
-				'singularity',
-				'run',
-				'-e',
-				'--contain',
-				'--nv',
-				'-B',
-				f'{inputs_dir}:/INPUTS/',
-				'-B',
-				f'{self._outdir}:/OUTPUTS',
-				'-B',
-				f'{self._tempdir}:/tmp',
-				'-B',
-				'/n/sw/ncf/apps/freesurfer/6.0.0/license.txt:/APPS/freesurfer/license.txt',
-				'-B',
-				'/n/sw/helmod-rocky8/apps/Core/cuda/9.1.85-fasrc01:/usr/local/cuda',
-				'-B',
-				'/n/nrg_l3/Lab/users/nrgadmin/PreQual/src/CODE/dtiQA_v7/run_dtiQA.py:/CODE/dtiQA_v7/run_dtiQA.py',
-				'-B',
-				'/n/nrg_l3/Lab/users/nrgadmin/PreQual/src/CODE/dtiQA_v7/vis.py:/CODE/dtiQA_v7/vis.py',
-				'/n/sw/ncf/containers/masilab/prequal/1.0.8/prequal.sif',
-				'--save_component_pngs',
-				'j',
-				'--eddy_cuda',
-				'9.1',
-				'--num_threads',
-				'2',
-				'--denoise',
-				'off',
-				'--degibbs',
-				'off',
-				'--rician',
-				'off',
-				'--prenormalize',
-				'on',
-				'--correct_bias',
-				'on',
-				'--topup_first_b0s_only',
-				'--nonzero_shells',
-				'350,650,1350,2000',
-				'--subject',
-				self._sub,
-				'--project',
-				'SSBC',
-				'--session',
-				self._ses
-			]	
+		if self._nonzero_shells == False:
+			if self._no_gpu:
+				self._command = [
+					'selfie',
+					'--lock',
+					'--output-file', self._prov,
+					'singularity',
+					'run',
+					'-e',
+					'--contain',
+					'-B',
+					f'{inputs_dir}:/INPUTS/',
+					'-B',
+					f'{self._outdir}:/OUTPUTS',
+					'-B',
+					f'{self._tempdir}:/tmp',
+					'-B',
+					'/n/sw/ncf/apps/freesurfer/6.0.0/license.txt:/APPS/freesurfer/license.txt',
+					'-B',
+					'/n/nrg_l3/Lab/users/nrgadmin/PreQual/src/CODE/dtiQA_v7/run_dtiQA.py:/CODE/dtiQA_v7/run_dtiQA.py',
+					'-B',
+					'/n/nrg_l3/Lab/users/nrgadmin/PreQual/src/CODE/dtiQA_v7/vis.py:/CODE/dtiQA_v7/vis.py',
+					'/n/sw/ncf/containers/masilab/prequal/1.0.8/prequal.sif',
+					'--save_component_pngs',
+					'j',
+					'--num_threads',
+					'2',
+					'--denoise',
+					'off',
+					'--degibbs',
+					'off',
+					'--rician',
+					'off',
+					'--prenormalize',
+					'on',
+					'--correct_bias',
+					'on',
+					'--topup_first_b0s_only',
+					'--subject',
+					self._sub,
+					'--project',
+					'SSBC',
+					'--session',
+					self._ses
+				]
+			else:
+				self._command = [
+					'selfie',
+					'--lock',
+					'--output-file', self._prov,
+					'singularity',
+					'run',
+					'-e',
+					'--contain',
+					'--nv',
+					'-B',
+					f'{inputs_dir}:/INPUTS/',
+					'-B',
+					f'{self._outdir}:/OUTPUTS',
+					'-B',
+					f'{self._tempdir}:/tmp',
+					'-B',
+					'/n/sw/ncf/apps/freesurfer/6.0.0/license.txt:/APPS/freesurfer/license.txt',
+					'-B',
+					'/n/sw/helmod-rocky8/apps/Core/cuda/9.1.85-fasrc01:/usr/local/cuda',
+					'-B',
+					'/n/nrg_l3/Lab/users/nrgadmin/PreQual/src/CODE/dtiQA_v7/run_dtiQA.py:/CODE/dtiQA_v7/run_dtiQA.py',
+					'-B',
+					'/n/nrg_l3/Lab/users/nrgadmin/PreQual/src/CODE/dtiQA_v7/vis.py:/CODE/dtiQA_v7/vis.py',
+					'/n/sw/ncf/containers/masilab/prequal/1.0.8/prequal.sif',
+					'--save_component_pngs',
+					'j',
+					'--eddy_cuda',
+					'9.1',
+					'--num_threads',
+					'2',
+					'--denoise',
+					'off',
+					'--degibbs',
+					'off',
+					'--rician',
+					'off',
+					'--prenormalize',
+					'on',
+					'--correct_bias',
+					'on',
+					'--topup_first_b0s_only',
+					'--subject',
+					self._sub,
+					'--project',
+					'SSBC',
+					'--session',
+					self._ses
+				]
+
+		elif self._nonzero_shells == True:
+			if self._no_gpu:
+
+				self._command = [
+					'selfie',
+					'--lock',
+					'--output-file', self._prov,
+					'singularity',
+					'run',
+					'-e',
+					'--contain',
+					'-B',
+					f'{inputs_dir}:/INPUTS/',
+					'-B',
+					f'{self._outdir}:/OUTPUTS',
+					'-B',
+					f'{self._tempdir}:/tmp',
+					'-B',
+					'/n/sw/ncf/apps/freesurfer/6.0.0/license.txt:/APPS/freesurfer/license.txt',
+					'-B',
+					'/n/nrg_l3/Lab/users/nrgadmin/PreQual/src/CODE/dtiQA_v7/run_dtiQA.py:/CODE/dtiQA_v7/run_dtiQA.py',
+					'-B',
+					'/n/nrg_l3/Lab/users/nrgadmin/PreQual/src/CODE/dtiQA_v7/vis.py:/CODE/dtiQA_v7/vis.py',
+					'/n/sw/ncf/containers/masilab/prequal/1.0.8/prequal.sif',
+					'--save_component_pngs',
+					'j',
+					'--num_threads',
+					'2',
+					'--denoise',
+					'off',
+					'--degibbs',
+					'off',
+					'--rician',
+					'off',
+					'--prenormalize',
+					'on',
+					'--correct_bias',
+					'on',
+					'--topup_first_b0s_only',
+					'--nonzero_shells',
+					'350,650,1350,2000',
+					'--subject',
+					self._sub,
+					'--project',
+					'SSBC',
+					'--session',
+					self._ses
+				]
+			else:
+
+				self._command = [
+					'selfie',
+					'--lock',
+					'--output-file', self._prov,
+					'singularity',
+					'run',
+					'-e',
+					'--contain',
+					'--nv',
+					'-B',
+					f'{inputs_dir}:/INPUTS/',
+					'-B',
+					f'{self._outdir}:/OUTPUTS',
+					'-B',
+					f'{self._tempdir}:/tmp',
+					'-B',
+					'/n/sw/ncf/apps/freesurfer/6.0.0/license.txt:/APPS/freesurfer/license.txt',
+					'-B',
+					'/n/sw/helmod-rocky8/apps/Core/cuda/9.1.85-fasrc01:/usr/local/cuda',
+					'-B',
+					'/n/nrg_l3/Lab/users/nrgadmin/PreQual/src/CODE/dtiQA_v7/run_dtiQA.py:/CODE/dtiQA_v7/run_dtiQA.py',
+					'-B',
+					'/n/nrg_l3/Lab/users/nrgadmin/PreQual/src/CODE/dtiQA_v7/vis.py:/CODE/dtiQA_v7/vis.py',
+					'/n/sw/ncf/containers/masilab/prequal/1.0.8/prequal.sif',
+					'--save_component_pngs',
+					'j',
+					'--eddy_cuda',
+					'9.1',
+					'--num_threads',
+					'2',
+					'--denoise',
+					'off',
+					'--degibbs',
+					'off',
+					'--rician',
+					'off',
+					'--prenormalize',
+					'on',
+					'--correct_bias',
+					'on',
+					'--topup_first_b0s_only',
+					'--nonzero_shells',
+					'350,650,1350,2000',
+					'--subject',
+					self._sub,
+					'--project',
+					'SSBC',
+					'--session',
+					self._ses
+				]
 
 		logdir = self.logdir()
 		logfile = os.path.join(logdir, 'dwiqc-prequal.log')
-		self.job = Job(
-			name='dwiqc-prequal',
-			time='3000',
-			memory='40G',
-			gpus=1,
-			nodes=1,
-			command=self._command,
-			output=logfile,
-			error=logfile
-		)
-
+		if self._no_gpu:
+			self.job = Job(
+				name='dwiqc-prequal',
+				time='3000',
+				memory='40G',
+				cpus=2,
+				nodes=1,
+				command=self._command,
+				output=logfile,
+				error=logfile
+			)
+		else:
+			self.job = Job(
+				name='dwiqc-prequal',
+				time='3000',
+				memory='40G',
+				gpus=1,
+				nodes=1,
+				command=self._command,
+				output=logfile,
+				error=logfile
+			)
 
 
 
 class DWISpecError(Exception):
 	pass
```

## dwiqc/tasks/qsiprep.py

```diff
@@ -18,26 +18,32 @@
 #module('load', 'cuda/9.1.85-fasrc01')
 
 
 logger = logging.getLogger(__name__)
 
 
 class Task(tasks.BaseTask):
-	def __init__(self, sub, ses, run, bids, outdir, output_resolution=None, tempdir=None, pipenv=None):
+	def __init__(self, sub, ses, run, bids, outdir, no_gpu=False, output_resolution=None, tempdir=None, pipenv=None):
 		self._sub = sub
 		self._ses = ses
 		self._run = run
 		self._bids = bids
+		self._no_gpu = no_gpu
 		self._layout = BIDSLayout(bids)
 		self._output_resolution = output_resolution
 		super().__init__(outdir, tempdir, pipenv)
 
 
 
 	def calc_mporder(self):
+		## if --no-gpu argument is passed, make mporder equal to 1
+		if self._no_gpu:
+			mporder = 1
+			return mporder
+
 		# need to get the length of the SliceTiming File (i.e. number of slices) divided by the "MultibandAccelerationFactor". From there, 
 		# divide that number by 3. That's the number passed to mporder.
 
 		# this will grab the dwi file, pop it off the list, get the slice timing metadata, then grab the length of the slice timing array
 		num_slices = len(self._layout.get(subject=self._sub, session=self._ses, run=self._run, suffix='dwi', extension='.nii.gz').pop().get_metadata()['SliceTiming'])
 
 		multiband_factor = self._layout.get(subject=self._sub, session=self._ses, run=self._run, suffix='dwi', extension='.nii.gz').pop().get_metadata()['MultibandAccelerationFactor']
@@ -79,103 +85,115 @@
 		if len(dwi_file) > 1:
 			raise DWISpecError('Found more than one dwi file. Please verify there are no duplicates.')
 		if not dwi_file:
 			raise DWISpecError(f'No dwi scan found for subject {self._sub} session {self._ses} run {self._run}')
 		else:
 			dwi_file = dwi_file.pop()
 
-		series_desc = dwi_file.get_metadata()['SeriesDescription']
+		json_file = self._layout.get(subject=self._sub, session=self._ses, run=self._run, suffix='dwi', extension='.json', return_type='filename').pop()
 
-		if 'ABCD_dMRI_lowSR' in series_desc:
-			# Define the values
-			ABCD_values = """0 27 54
-			2 29 56
-			4 31 58
-			6 33 60
-			8 35 62
-			10 37 64
-			12 39 66
-			14 41 68
-			16 43 70
-			18 45 72
-			20 47 74
-			22 49 76
-			24 51 78
-			26 53 80
-			1 28 55
-			3 30 57
-			5 32 59
-			7 34 61
-			9 36 63
-			11 38 65
-			13 40 67
-			15 42 69
-			17 44 71
-			19 46 73
-			21 48 75
-			23 50 77
-			25 52 79"""
-
-			# Create a text file
-			with open(f"{self._bids}/slspec_ABCD_dMRI.txt", "w") as file:
-				# Write the values into the text file
-				file.write(ABCD_values)
-
-			return 'slspec_ABCD_dMRI.txt'
-
-
-		# check for the UK Bio bank version of the scan and then create the slspec file accordingly
-
-		elif 'UKbioDiff_ABCDseq_ABCDdvs' in series_desc:
-			# Define Values
-			UKBio_values = """1 25 49
-			3 27 51
-			5 29 53
-			7 31 55
-			9 33 57
-			11 35 59
-			23 47 71
-			13 37 61
-			15 39 63
-			17 41 65
-			19 43 67
-			21 45 69
-			2 26 50
-			4 28 52
-			6 30 54
-			8 32 56
-			10 34 58
-			12 36 60
-			0 24 48
-			14 38 62
-			16 40 64
-			18 42 66
-			20 44 68
-			22 46 70"""
-
-
-			# Create a text file
-			with open(f"{self._bids}/slspec_UKBio_dMRI.txt", "w") as file:
-				# Write the values into the text file
-				file.write(UKBio_values)
+		# Grab the slice timing info
+		slice_timing = dwi_file.get_metadata()['SliceTiming']
 
-			return 'slspec_UKBio_dMRI.txt'
+		# sort it in ascending order
+		slice_timing.sort()
 
+		# remove any duplicates
+		slice_timing = list(set(slice_timing))
 
-		
+		# get the total number of slices
+		num_slices = len(slice_timing)
+
+		# check if there's an even or odd number of slices, run corresponding helper method
+		if num_slices % 2 == 0:
+			self.even_slices(json_file)
 
 		else:
-			logger.info('Unable to determine dwi scan type. Moving on without creating slspec file.')
+			self.odd_slices(json_file)
+
+	# helper method that creates slspec file for an acquisition with an even number of slices
+
+	# if the number of slices is even, create spec file accordingly. source = https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/eddy/Faq#How_should_my_--slspec_file_look.3F
+    # line 138 edited from `item - 1` to `item - 0`
+
+	def even_slices(self, json_file):
+		# open the json file and 
+		with open(json_file, 'r') as fp:
+			fcont = fp.read()
+
+		i1 = fcont.find('SliceTiming')
+		i2 = fcont[i1:].find('[')
+		i3 = fcont[i1 + i2:].find(']')
+		cslicetimes = fcont[i1 + i2 + 1:i1 + i2 + i3]
+		slicetimes = list(map(float, cslicetimes.split(',')))
+		sortedslicetimes = sorted(slicetimes)
+		sindx = sorted(range(len(slicetimes)), key=lambda k: slicetimes[k])
+		mb = len(sortedslicetimes) // (sum(1 for a, b in zip(sortedslicetimes, sortedslicetimes[1:]) if a != b) + 1)
+		slspec = [sindx[i:i + mb] for i in range(0, len(sindx), mb)]
+		slspec = [[item - 0 for item in sublist] for sublist in slspec]
+
+		spec_file = f"{self._bids}/even_slices_slspec.txt"
+
+		with open(spec_file, 'w') as fp:
+			for sublist in slspec:
+				fp.write(' '.join(str(item) for item in sublist))
+				fp.write('\n')
+
+		self._spec = spec_file
+
+
+	# helper method that generates slspec file for an acquisition with an odd number of slices
+
+	def odd_slices(self, json_file):
+		## build the first column
+
+		col1 = []
+
+		for i in range(0, num_slices, 2):
+			col1.append(i)
 
+		for j in range(1, num_slices, 2):
+			col1.append(j)
+
+		col1 = np.array(col1)
+
+		if len(col1) != num_slices:
+			raise DWISpecError('Spec file column does not match length of slice timing file. Exiting.')
+
+		## build second column
+
+		col2 = []
+
+		for col1_num in col1:
+			col2_num = col1_num + num_slices
+			col2.append(col2_num)
+		col2 = np.array(col2)
+
+		# build third column
+
+		col3 = []
+
+		for col2_num in col2:
+			col3_num = col2_num + num_slices
+			col3.append(col3_num)
+		col3 = np.array(col3)
+
+		all_cols = np.column_stack([col1, col2, col3])
+
+		spec_file = f"{self._bids}/odd_slices_slspec.txt"
+
+		np.savetxt(spec_file, data, fmt=['%d', '%d', '%d'])
+
+		self._spec = spec_file
 
 	# create necessary fsl eddy parameters json file using output from create_spec and calc_mporder
 
 	def create_eddy_params(self):
 		mporder = self.calc_mporder()
-		spec_file = self.create_spec()
+		self.create_spec()
 		params_file = {
 			"flm": "quadratic",
 			"slm": "linear",
 			"fep": False,
 			"interp": "spline",
 			"nvoxhp": 1000,
 			"fudge_factor": 10,
@@ -188,15 +206,15 @@
 			"is_shelled": True,
 			"use_cuda": True,
 			"cnr_maps": True,
 			"residuals": True,
 			"output_type": "NIFTI_GZ",
 			"estimate_move_by_susceptibility": True,
 			"mporder": mporder,
-			"slice_order": f"{self._bids}/{spec_file}",
+			"slice_order": self._spec,
 			"args": "--ol_nstd=5 --ol_type=gw"
 		}
 
 		with open(f"{self._bids}/eddy_params_s2v_mbs.json", "w") as f:
 			json.dump(params_file, f)
 
 	# create qsiprep command to be executed
@@ -232,23 +250,38 @@
 			'40000',
 			'--fs-license-file',
 			'/n/helmod/apps/centos7/Core/freesurfer/6.0.0-fasrc01/license.txt',
 			'-w',
 			self._tempdir
 		]
 
-		logdir = self.logdir()
-		logfile = os.path.join(logdir, 'dwiqc-qsiprep.log')
-		self.job = Job(
-			name='dwiqc-qsiprep',
-			time='3000',
-			memory='40G',
-			gpus=1,
-			nodes=1,
-			command=self._command,
-			output=logfile,
-			error=logfile
-		)
+		if self._no_gpu:
+			logdir = self.logdir()
+			logfile = os.path.join(logdir, 'dwiqc-qsiprep.log')
+			self.job = Job(
+				name='dwiqc-qsiprep',
+				time='3000',
+				memory='40G',
+				cpus=2,
+				nodes=1,
+				command=self._command,
+				output=logfile,
+				error=logfile
+			)
+
+		else:
+			logdir = self.logdir()
+			logfile = os.path.join(logdir, 'dwiqc-qsiprep.log')
+			self.job = Job(
+				name='dwiqc-qsiprep',
+				time='3000',
+				memory='40G',
+				gpus=1,
+				nodes=1,
+				command=self._command,
+				output=logfile,
+				error=logfile
+			)
```

## Comparing `dwiqc-0.5.9.data/scripts/dwiQC.py` & `dwiqc-0.6.0.data/scripts/dwiQC.py`

 * *Files 3% similar despite different names*

```diff
@@ -60,14 +60,16 @@
         help='BIDS run')
     parser_process.add_argument('--bids-dir', required=True,
         help='BIDS root directory')
     parser_process.add_argument('--output-resolution-process',
         help='Resolution of output data. Defaut is resolution of input data.')
     parser_process.add_argument('--dry-run', action='store_true',
         help='Do not execute any jobs')
+    parser_process.add_argument('--no-gpu', action='store_true',
+        help='Run prequal and qsiprep without gpu functionality.')
     parser_process.add_argument('--sub-tasks', nargs='+', default=['prequal', 'qsiprep'],
         help='Run only certain sub tasks')
     parser_process.add_argument('--fs-license',
         help='Base64 encoded FreeSurfer license file')
     parser_process.add_argument('--xnat-alias',
         help='YAXIL authentication alias')
     parser_process.add_argument('--xnat-host',
@@ -98,14 +100,16 @@
         help='Job scheduler partition')
     parser_tandem.add_argument('--scheduler', default=None,
         help='Choose a specific job scheduler')
     parser_tandem.add_argument('--rate-limit', type=int, default=None, 
         help='Rate limit the number of tasks executed in parallel (1=serial)')
     parser_tandem.add_argument('--dry-run', action='store_true',
         help='Do not execute any jobs')
+    parser_tandem.add_argument('--no-gpu', action='store_true',
+        help='Run prequal and qsiprep without gpu functionality.')
     parser_tandem.add_argument('--sub-tasks', nargs='+', default=['prequal', 'qsiprep'],
         help='Run only certain sub tasks')
     parser_tandem.add_argument('--fs-license',
         help='Base64 encoded FreeSurfer license')
     parser_tandem.add_argument('--xnat-alias',
         help='YAXIL authentication alias')
     parser_tandem.add_argument('--xnat-host',
```

## Comparing `dwiqc-0.5.9.dist-info/LICENSE` & `dwiqc-0.6.0.dist-info/LICENSE`

 * *Files identical despite different names*

## Comparing `dwiqc-0.5.9.dist-info/RECORD` & `dwiqc-0.6.0.dist-info/RECORD`

 * *Files 8% similar despite different names*

```diff
@@ -1,22 +1,22 @@
 dwiqc/__init__.py,sha256=MZJhUZKhHHoZ2w_GeoFCITk1m_0ASdRw_ZaeDixFEPU,225
-dwiqc/__version__.py,sha256=Sq-2-ZCRE7Mf12tZsbEc8SNBN4bX0X1K2CPUOczVn8Q,247
+dwiqc/__version__.py,sha256=KtmgDXlNbapHhH_Ac9yg-GV1JKh3fCN1lwAOKacGdU8,247
 dwiqc/browser/__init__.py,sha256=4lK-1-VH4l6ppP_5Ju6MeYIctiQmFQfGA7gclqh8euE,1352
 dwiqc/cli/__init__.py,sha256=1Y4dYEbkHH-jZ3cwbFnlb6TthH_K0t4xT_-IphRBu6k,61
 dwiqc/cli/get.py,sha256=w2jLbFA7unwfZ-DghKG-_3vPb1RhZPAYX-nXOEbC8wk,6941
-dwiqc/cli/process.py,sha256=puk84elvo7iMNdSiMGsKDIv1s1HQndd-Wiylj_iQh00,5945
+dwiqc/cli/process.py,sha256=HYnB49FFYXOq2NZzWR5RfiLe824coWKQndXxDo-AiDs,6009
 dwiqc/cli/tandem.py,sha256=18t_cn0VrXeAhohg8ukBnDydsR8ZiB8vM0_AZI1Ohkg,4180
 dwiqc/config/__init__.py,sha256=k_w5JzoJN_7R7eI_sIJxHA4FQQHs0_KGf-6jsbG4Xs8,160
 dwiqc/config/dwiqc.yaml,sha256=x8gKMFZyChdzvNX3GthRe0eWvyKDDL5itXo0kLWVfd0,274
 dwiqc/state/__init__.py,sha256=NaRifw26bI3F1J9BqeLa-KLSzEPq2m_UNhMbXdmPdh4,98
 dwiqc/tasks/__init__.py,sha256=LnlN7iYjpqiBic2ihFrM-_h7m8FD_N7Beh7UIwKyGZ8,1892
-dwiqc/tasks/prequal.py,sha256=HQEmCcy1DvADMAAPdEHhLKX8Ep80JNJyApYCXQdw64Q,10119
+dwiqc/tasks/prequal.py,sha256=B4X2kQkumV1RE0-IyxTHkDNR4zHJ3l2B0QHLL80FVBE,15219
 dwiqc/tasks/prequal_EQ.py,sha256=hvs6qjRNoJXuCzdvP-9BnaZc4xwvI9LHSgmueRobt1Q,4656
-dwiqc/tasks/qsiprep.py,sha256=hYubJufE8_B9zVjEuOXamKRwg4Afxw7fj2ClWhUzzU8,6146
+dwiqc/tasks/qsiprep.py,sha256=nDxcKcyBvHknRz8ddR2vJmSygRXuNBlhN3RklmsBNU8,7849
 dwiqc/tasks/qsiprep_EQ.py,sha256=oj9kJ4hRBlq8mT4Mp-ogakoOTVFbfJ2yUxcwoXPN4j8,3872
 dwiqc/xnat/__init__.py,sha256=fjdic3dblSWMag4vOwCcgyHgD2pBcu7qICNrt7HBwVU,13087
-dwiqc-0.5.9.data/scripts/dwiQC.py,sha256=9FvCPyuitQXOZOjcW3DQcyXL6jJ3-X9J9zxtkTSsYGw,5783
-dwiqc-0.5.9.dist-info/LICENSE,sha256=ReOF9BmlQdkCj4b2gQYogJrk_QkbUAuz8W1ZVqI0pcs,1541
-dwiqc-0.5.9.dist-info/METADATA,sha256=UihWpBAKpJt3AG2Wr16COxkvOJYBQ69lIOv09aLeMvE,483
-dwiqc-0.5.9.dist-info/WHEEL,sha256=WzZ8cwjh8l0jtULNjYq1Hpr-WCqCRgPr--TX4P5I1Wo,110
-dwiqc-0.5.9.dist-info/top_level.txt,sha256=omH7pmKt7fzFyiNkTPDLX4yyBccoge5Saqc9rgyu0Wk,6
-dwiqc-0.5.9.dist-info/RECORD,,
+dwiqc-0.6.0.data/scripts/dwiQC.py,sha256=4ZHaJbGDMCkY-CHztDoBK2NmY78Xq9wA_nUV_PtlZUw,6046
+dwiqc-0.6.0.dist-info/LICENSE,sha256=ReOF9BmlQdkCj4b2gQYogJrk_QkbUAuz8W1ZVqI0pcs,1541
+dwiqc-0.6.0.dist-info/METADATA,sha256=r-AgOxeOLd5NEB6aaBOsCkO-5c1TcZ9vIUiNVQYN9n0,439
+dwiqc-0.6.0.dist-info/WHEEL,sha256=a-zpFRIJzOq5QfuhBzbhiA1eHTzNCJn8OdRvhdNX0Rk,110
+dwiqc-0.6.0.dist-info/top_level.txt,sha256=omH7pmKt7fzFyiNkTPDLX4yyBccoge5Saqc9rgyu0Wk,6
+dwiqc-0.6.0.dist-info/RECORD,,
```

